<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Visualização da Tabela - FVS e Apartamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0d1117;
      --card:#161b22;
      --text:#c9d1d9;
      --muted:#8b949e;
      --border:#30363d;
      --blue:#58a6ff;
      --green:#238636;
      --yellow:#d29922;
      --gray:#6e7681;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:0;
      background-color:var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height:1.5;
    }

    /* Top bar */
    #dropdown-container{
      position:sticky;
      top:0;
      background-color:var(--bg);
      border-bottom:1px solid var(--border);
      z-index:1000;
      padding:16px;
      width:100%;
      max-width:600px;
      text-align:center;
    }
    select#dropdown{
      background-color:#161b22;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 40px 10px 12px;
      font-size:14px;
      font-family:'Inter',sans-serif;
      transition:border-color .2s ease, background-color .2s ease, box-shadow .2s ease;
      outline:none;
      width:100%;
      cursor:pointer;
      appearance:none;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23c9d1d9" d="M6 8.5L11 3.5H1z"/></svg>');
      background-repeat:no-repeat;
      background-position:right 12px center;
      background-size:12px;
    }
    select#dropdown:hover{ border-color:#8b949e }
    select#dropdown:focus{
      border-color:var(--blue);
      box-shadow:0 0 0 3px rgba(88,166,255,.2);
      background-color:#21262d;
    }

    /* SVG area */
    #svg-container{
      padding:24px;
      max-width:100%;
      overflow-x:auto;
      width:100%;
      flex-grow:1;
      margin-top:8px;
    }
    /* >>> escopado só para o canvas principal, NÃO afeta o ícone <<< */
    #svg{
      background-color:#161b22;
      border-radius:12px;
      border:1px solid var(--border);
      display:block;
      margin:auto;
      max-width:100%;
      height:auto;
      min-height:300px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }
    text{
      font-family:'Inter',sans-serif;
      pointer-events:none;
      fill:var(--text);
      font-size:clamp(6px,1.2vw,12px);
      text-anchor:start;
      dominant-baseline:hanging;
      user-select:none;
    }
    .cell{
      cursor:pointer;
      transition:filter .2s ease, transform .15s ease;
      stroke:var(--border);
      stroke-width:1;
      rx:0; ry:0;
    }
    .cell:hover{ filter:brightness(1.2) }
    .apt-text{
      pointer-events:none;
      font-size:clamp(5px,1vw,8px);
      fill:var(--text);
      font-weight:500;
      text-anchor:start;
      dominant-baseline:hanging;
      user-select:none;
      opacity:0;
      transition:opacity .2s ease;
    }
    rect.cell.active + .apt-text,
    rect.cell:hover + .apt-text{ opacity:1 }
    .duracao-text{
      pointer-events:none;
      fill:var(--text);
      font-weight:600;
      font-size:clamp(6px,1.2vw,12px);
      text-anchor:middle;
      dominant-baseline:middle;
      transition:opacity .2s ease;
      opacity:1;
      user-select:none;
    }
    rect.cell.active + .apt-text + .duracao-text,
    rect.cell:hover + .apt-text + .duracao-text{ opacity:0 }

    /* Loading */
    #loading{
      position:fixed; inset:0;
      background-color:rgba(13,17,23,.8);
      display:flex; justify-content:center; align-items:center;
      z-index:9999; visibility:hidden; opacity:0;
      transition:opacity .3s ease;
      pointer-events:none;
    }
    #loading.show{ visibility:visible; opacity:1; pointer-events:auto }
    .spinner{
      border:4px solid var(--border);
      border-top:4px solid var(--blue);
      border-radius:50%;
      width:40px; height:40px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* ====== ANDROID-LIKE SHADE EFFECT ====== */
    #modal-backdrop{
      position:fixed; inset:0;
      display:none; /* toggled to flex */
      justify-content:center; align-items:center;
      z-index:10000;
      background:rgba(13,17,23,0.35);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      backdrop-filter: blur(14px) saturate(120%);
      animation:fadeIn .25s ease;
    }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    /* Card do modal com translucidez */
    #modal{
      position:relative;
      width:clamp(280px, 90vw, 520px);
      max-height:80vh;
      overflow:auto;
      padding:22px;
      border-radius:16px;
      background:rgba(22,27,34,0.4);
      border:1px solid rgba(240,246,252,0.08);
      box-shadow:
        0 10px 30px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.03);
      -webkit-backdrop-filter: blur(6px) saturate(110%);
      backdrop-filter: blur(6px) saturate(110%);
      color:var(--text);
      font-size:14px;
      animation:slideUp .25s ease;
    }
    @keyframes slideUp{ from{ transform:translateY(10px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

    /* esconder a barra mas manter rolagem */
    #modal::-webkit-scrollbar{ width:0; height:0 }
    #modal{ scrollbar-width:none; -ms-overflow-style:none; overscroll-behavior:contain; }

    #modal h2{
      margin:0 0 12px; font-weight:600; font-size:18px; color:#f0f6fc;
      border-bottom:1px solid rgba(240,246,252,0.06);
      padding-bottom:8px; text-align:left;
    }
    #modal p{ margin:8px 0; line-height:1.6; color:var(--text) }
    #modal hr{
      border:none; border-top:1px solid rgba(240,246,252,0.06); margin:12px 0;
    }
    #modal table{
      width:100%; border-collapse:collapse; margin-top:8px; font-size:13px;
    }
    #modal th, #modal td{
      text-align:left; padding:8px 4px;
      border-bottom:1px solid rgba(240,246,252,0.06);
    }
    #modal th{ color:var(--muted); font-weight:500 }
    #modal td{ color:var(--text) }

    #modal button.close-btn{
      position:absolute; top:10px; right:10px;
      background:rgba(240,246,252,0.04);
      border:1px solid rgba(240,246,252,0.08);
      color:#f0f6fc; font-size:16px; cursor:pointer; font-weight:700;
      line-height:1; padding:6px 10px; border-radius:10px;
      transition:transform .12s ease, background-color .15s ease, border-color .15s ease;
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }
    #modal button.close-btn:hover{
      background:rgba(240,246,252,0.08);
      border-color:rgba(240,246,252,0.14);
      transform:scale(1.03);
    }

    /* link “linha inteira” no modal */
    #modal a.link-row{
      color:inherit;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:2px 6px;
      border-radius:8px;
      transition:background-color .15s ease, transform .05s ease;
      vertical-align:middle;
    }
    #modal a.link-row:hover{
      background-color:rgba(240,246,252,0.06);
      text-decoration:none;
    }
    #modal a.link-row:active{ transform:scale(0.99) }
    #modal a.link-row svg{
      width:14px; height:14px;
      display:inline-block;
      flex:0 0 auto;
      stroke:currentColor;
    }

    @media (max-width:600px){
      #dropdown-container{ padding:12px; max-width:100% }
      #modal{ width:95%; padding:16px }
      #modal h2{ font-size:16px }
      #modal table{ font-size:12px }
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important }
    }
  </style>
</head>
<body>
  <div id="dropdown-container">
    <label for="dropdown" style="display:none;">Selecionar FVS</label>
    <select id="dropdown">
      <option value="">Carregando FVS...</option>
    </select>
  </div>

  <div id="svg-container">
    <svg id="svg" xmlns="http://www.w3.org/2000/svg">
      <text x="10" y="20" fill="#c9d1d9">Selecione uma FVS</text>
    </svg>
  </div>

  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Backdrop com blur (Android-like) -->
  <div id="modal-backdrop" tabindex="-1" aria-hidden="true">
    <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="0">
      <button class="close-btn" aria-label="Fechar modal">✕</button>
      <h2 id="modal-title">Detalhes do Apartamento</h2>
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
    /* ===== NOVO: base de dados estática no GitHub Pages ===== */
    const DATA_BASE = 'https://dogeconstrutora.github.io/doge/data';
    const FVS_LIST_URL = `${DATA_BASE}/fvs-list.json`;
    const APARTAMENTOS_URL = `${DATA_BASE}/apartamentos.json`;

    /* Mantemos sua estrutura CSV (andares/apts) como está */
    const ESTRUTURA_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRYGuSxR-9vY5Uj7tIDEZXtyCaTLPuyklhHrBQEv0o1YdhLb_XYKazJnZDFpBfgmoHgqYq_Lbe1QWju/pub?output=csv';

    const CELL_WIDTH = 50;
    const CELL_HEIGHT = 30;

    const loadingDiv = document.getElementById('loading');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalContent = document.getElementById('modal-content');
    const modalCloseBtn = document.querySelector('#modal button.close-btn');

    /* Cache */
    const cache = { estruturaCsv:null, apartamentos:null };

    /* Estado atual da FVS */
    let currentFvs = '';
    let currentFvsItems = [];
    let currentByApt = Object.create(null);

    function showLoading(){ loadingDiv.classList.add('show'); }
    function hideLoading(){ loadingDiv.classList.remove('show'); }

    function lockScroll(lock){
      if(lock){
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      }else{
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
      }
    }

    async function loadCSV(url){
      if(cache.estruturaCsv) return cache.estruturaCsv;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP status ${res.status}`);
      const text = await res.text();
      const lines = text.trim().split('\n');
      const data = lines.map(line => line.split(',').map(cell => cell.trim()));
      cache.estruturaCsv = data;
      return data;
    }

    function expandRow(row){
      let lastValue = "";
      return row.map(cell => {
        if(cell) lastValue = cell;
        return lastValue;
      });
    }

    function groupCells(grid){
      const visited = Array.from({ length:grid.length }, () =>
        Array(grid[0].length).fill(false)
      );
      const groups = [];
      const rows = grid.length;
      const cols = grid[0].length;
      const directions = [[0,1],[1,0],[-1,0],[0,-1]];
      function bfs(r,c,value){
        const queue = [[r,c]];
        const group = [];
        while(queue.length){
          const [x,y] = queue.shift();
          if(x<0||x>=rows||y<0||y>=cols||visited[x][y]||grid[x][y]!==value) continue;
          visited[x][y] = true;
          group.push([x,y]);
          for(const [dx,dy] of directions) queue.push([x+dx,y+dy]);
        }
        return group;
      }
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cellValue = grid[r][c];
          if(!visited[r][c] && cellValue && cellValue.toLowerCase()!=="vazio"){
            const group = bfs(r,c,cellValue);
            groups.push({ value:cellValue, cells:group });
          }
        }
      }
      return groups;
    }

    function formatDateBR(dateStr){
      if(!dateStr) return "";
      const parts = dateStr.split('-');
      if(parts.length<3) return dateStr;
      const yyyy = parseInt(parts[0],10);
      const mm = parseInt(parts[1],10)-1;
      const dd = parseInt(parts[2].substring(0,2),10);
      const d = new Date(yyyy,mm,dd);
      if(isNaN(d)) return dateStr;
      return `${String(dd).padStart(2,'0')}/${String(mm+1).padStart(2,'0')}/${yyyy}`;
    }

    /* Mantido como fallback (caso precise deduzir a última inspeção das reaberturas) */
    function getUltimaInspecaoInfo(reaberturas){
      if(!Array.isArray(reaberturas)||reaberturas.length===0){
        return { codigo_ultima_inspecao:null, qtd_pend_ultima_inspecao:0 };
      }
      let best=null;
      for(const r of reaberturas){
        const c = Number(r.codigo);
        if(!Number.isNaN(c)){
          if(!best || c>best.c) best = { c, q:Number(r.qtd_itens_pendentes)||0 };
        }
      }
      if(best) return { codigo_ultima_inspecao:String(best.c), qtd_pend_ultima_inspecao:best.q };
      const last = reaberturas[reaberturas.length-1];
      return {
        codigo_ultima_inspecao: last.codigo ?? null,
        qtd_pend_ultima_inspecao: Number(last.qtd_itens_pendentes) || 0
      };
    }

    function draw(groups, duracoesMap, fvsSelecionada){
      const svg = document.getElementById('svg');
      svg.innerHTML = '';
      let maxWidth=0, maxHeight=0;

      if(!fvsSelecionada){
        svg.innerHTML = '<text x="10" y="20" fill="#c9d1d9">Selecione uma FVS</text>';
        return;
      }

      groups.forEach(group=>{
        if(group.value.toLowerCase()==='vazio') return;

        const cells = group.cells;
        let minRow=Infinity, minCol=Infinity, maxRow=-1, maxCol=-1;
        for(const [r,c] of cells){
          minRow=Math.min(minRow,r); minCol=Math.min(minCol,c);
          maxRow=Math.max(maxRow,r); maxCol=Math.max(maxCol,c);
        }
        const x = minCol*CELL_WIDTH;
        const y = minRow*CELL_HEIGHT;
        const width = (maxCol-minCol+1)*CELL_WIDTH;
        const height = (maxRow-minRow+1)*CELL_HEIGHT;

        maxWidth = Math.max(maxWidth, x+width);
        maxHeight = Math.max(maxHeight, y+height);

        const data = duracoesMap[group.value];
        let fillColor = getComputedStyle(document.documentElement).getPropertyValue('--gray') || '#6e7681';
        let textoCentro = '';
        if(data){
          textoCentro = `${data.duracao_real ?? ''}`;
          if(!data.data_termino_inicial){
            fillColor = '#1f6feb'; // azul: sem término inicial
          }else{
            const pend = Number(data.qtd_pend_ultima_inspecao||0);
            fillColor = pend>0 ? '#d29922' : '#238636'; // amarelo com pendências / verde sem
          }
        }

        const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
        rect.setAttribute("x",x); rect.setAttribute("y",y);
        rect.setAttribute("width",width); rect.setAttribute("height",height);
        rect.setAttribute("fill",fillColor); rect.setAttribute("class","cell");
        svg.appendChild(rect);

        const aptText = document.createElementNS("http://www.w3.org/2000/svg","text");
        aptText.setAttribute("x",x+3); aptText.setAttribute("y",y+3);
        aptText.setAttribute("class","apt-text"); aptText.textContent = group.value;
        svg.appendChild(aptText);

        const duracaoText = document.createElementNS("http://www.w3.org/2000/svg","text");
        duracaoText.setAttribute("x",x+width/2); duracaoText.setAttribute("y",y+height/2);
        duracaoText.setAttribute("class","duracao-text"); duracaoText.textContent = textoCentro;
        svg.appendChild(duracaoText);

        rect.addEventListener('click', ()=> abrirModalDetalhes(group.value, fvsSelecionada));
      });

      svg.setAttribute('viewBox', `0 0 ${maxWidth} ${maxHeight}`);
    }

    async function abrirModalDetalhes(apartamento, fvsSelecionada){
      modalContent.innerHTML = `<p>Carregando dados do apartamento ${apartamento}...</p>`;
      modalBackdrop.style.display = 'flex';
      lockScroll(true);
      try{
        const info = currentByApt[apartamento];
        if(!info){
          modalContent.innerHTML = `<p>Sem dados para o apartamento ${apartamento}.</p>`;
          return;
        }

        // Preferir os campos diretos do JSON; fallback para cálculo nas reaberturas
        let codUlt = info.codigo_ultima_inspecao;
        let pendUlt = info.qtd_pend_ultima_inspecao;
        if(codUlt == null){
          const aux = getUltimaInspecaoInfo(info.reaberturas);
          codUlt = aux.codigo_ultima_inspecao;
          pendUlt = aux.qtd_pend_ultima_inspecao;
        }

// depois (prefere a última; cai pra primeira como fallback):
const idLink = info.id_ultima_inspecao || info.id;
const inmetaUrl = idLink
  ? `https://app.inmeta.com.br/app/360/servico/inspecoes/realizadas?inspecao=${encodeURIComponent(idLink)}`
  : null;
        
        let html = `<p><strong>Apartamento:</strong> ${info.apartamento}</p>`;
        html += `<p><strong>Início:</strong> ${formatDateBR(info.data_abertura)}</p>`;
        if(info.data_termino_inicial){
          html += `<p><strong>Término:</strong> ${formatDateBR(info.data_termino_inicial)}</p>`;
        }
        html += `<p><strong>Duração inicial:</strong> ${info.duracao_inicial}</p>`;

        if(info.reaberturas?.length){
          html += `<hr><table><tr><th>Código</th><th>Data Abertura</th><th>Pendências</th></tr>`;
          info.reaberturas.forEach(r=>{
            html += `<tr><td>${r.codigo ?? '-'}</td><td>${formatDateBR(r.data_abertura)}</td><td>${r.qtd_itens_pendentes}</td></tr>`;
          });
          html += `</table>`;
          html += `<p><strong>Duração reinspeções:</strong> ${info.duracao_reaberturas || 0}</p>`;
        }

        if(inmetaUrl){
          html += `
          <p>
            <a class="link-row" href="${inmetaUrl}" target="_blank" rel="noopener noreferrer" aria-label="Abrir a última inspeção em nova aba">
              <span><strong>Última inspeção:</strong> código ${codUlt ?? '-'} | pendências ${pendUlt ?? '-'}</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M15 3h6v6"/>
                <path d="M10 14L21 3"/>
                <path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1-2-2h6"/>
              </svg>
            </a>
          </p>`;
        } else {
          html += `<p><strong>Última inspeção:</strong> código ${codUlt ?? '-'} | pendências ${pendUlt ?? '-'}</p>`;
        }

        html += `<p><strong>Duração total:</strong> ${info.duracao_real}</p>`;
        if(info.termino_final){
          html += `<p><strong>Término final:</strong> ${formatDateBR(info.termino_final)}</p>`;
        }
        modalContent.innerHTML = html;

        requestAnimationFrame(()=> document.getElementById('modal').focus());
      }catch(err){
        modalContent.innerHTML = `<p>Erro ao carregar dados: ${err.message}</p>`;
      }
    }

    function fecharModal(){
      modalBackdrop.style.display = 'none';
      modalContent.innerHTML = '';
      lockScroll(false);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      carregarFvs();
      document.getElementById('dropdown').addEventListener('change', e=>{
        carregarDuracoesEFazerDraw(e.target.value);
      });
      modalCloseBtn.addEventListener('click', fecharModal);
      modalBackdrop.addEventListener('click', e=>{
        if(e.target === modalBackdrop) fecharModal();
      });
      document.addEventListener('keydown', e=>{
        if(e.key==='Escape' && getComputedStyle(modalBackdrop).display==='flex') fecharModal();
      });
      // estado inicial do SVG já mostra "Selecione uma FVS"
    });

    /* ======= Lê fvs-list.json do GitHub ======= */
    async function carregarFvs(){
      const dropdown = document.getElementById('dropdown');
      dropdown.innerHTML = '<option value="">Carregando FVS...</option>';
      try{
        const res = await fetch(FVS_LIST_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error(`HTTP status ${res.status}`);
        const fvsList = await res.json();
        dropdown.innerHTML = '<option value="">-- Selecione uma FVS --</option>';
        for(const fvs of fvsList){
          const opt = document.createElement('option');
          opt.value = fvs; opt.textContent = fvs;
          dropdown.appendChild(opt);
        }
      }catch(e){
        dropdown.innerHTML = '<option value="">Erro ao carregar FVS</option>';
      }
    }

    /* ======= Ao escolher FVS, filtra apartamentos.json e desenha ======= */
    async function carregarDuracoesEFazerDraw(fvsSelecionada){
      showLoading();
      try{
        const rawGrid = await loadCSV(ESTRUTURA_CSV);
        const grid = rawGrid.map(row => expandRow(row.slice(1)));
        const groups = groupCells(grid);

        currentFvs = fvsSelecionada || '';
        currentFvsItems = [];
        currentByApt = Object.create(null);

        let duracoesMap = {};
        if(currentFvs){
          if(!cache.apartamentos){
            const res = await fetch(APARTAMENTOS_URL, { cache: 'no-store' });
            if(!res.ok) throw new Error(`HTTP status ${res.status}`);
            cache.apartamentos = await res.json(); // array com TODOS os aptos de TODAS as FVS
          }
          // filtra pela FVS escolhida
          currentFvsItems = cache.apartamentos.filter(it => it.fvs === currentFvs);

          for(const item of currentFvsItems){
            currentByApt[item.apartamento] = item;
            duracoesMap[item.apartamento] = {
              duracao_real: item.duracao_real,
              data_termino_inicial: item.data_termino_inicial,
              qtd_pend_ultima_inspecao: item.qtd_pend_ultima_inspecao || 0
            };
          }
        }

        draw(groups, duracoesMap, currentFvs);
      }catch(e){
        document.getElementById('svg').innerHTML =
          `<text x="10" y="20" fill="#c9d1d9">Erro: ${e.message}</text>`;
      }finally{
        hideLoading();
      }
    }
  </script>
</body>
</html>
