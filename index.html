<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Visualização da Tabela - FVS e Apartamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* === SEU CSS ORIGINAL AQUI (sem mudanças) === */
  </style>
</head>
<body>
  <div id="dropdown-container">
    <label for="dropdown" style="display:none;">Selecionar FVS</label>
    <select id="dropdown">
      <option value="">Carregando FVS...</option>
    </select>
  </div>

  <div id="svg-container">
    <svg id="svg" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <div id="loading">
    <div class="spinner"></div>
  </div>

  <div id="modal-backdrop" tabindex="-1" aria-hidden="true">
    <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="0">
      <button class="close-btn" aria-label="Fechar modal">✕</button>
      <h2 id="modal-title">Detalhes do Apartamento</h2>
      <div id="modal-content"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyQiJpxajuC0alNhKwiyzLH5nldPlQoe4SR8vE-CXE8IvmQNDKJLHrRFeQQkl6gD24e/exec';
    const ESTRUTURA_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRYGuSxR-9vY5Uj7tIDEZXtyCaTLPuyklhHrBQEv0o1YdhLb_XYKazJnZDFpBfgmoHgqYq_Lbe1QWju/pub?output=csv';

    const CELL_WIDTH = 50;
    const CELL_HEIGHT = 30;

    const loadingDiv = document.getElementById('loading');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalContent = document.getElementById('modal-content');
    const modalCloseBtn = document.querySelector('#modal button.close-btn');

    const cache = { fvsList:null, duracoes:{}, estruturaCsv:null };

    function showLoading(){ loadingDiv.classList.add('show'); }
    function hideLoading(){ loadingDiv.classList.remove('show'); }
    function lockScroll(lock){
      document.documentElement.style.overflow = lock ? 'hidden' : '';
      document.body.style.overflow = lock ? 'hidden' : '';
    }

    async function loadCSV(url){
      if(cache.estruturaCsv) return cache.estruturaCsv;
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.trim().split('\n');
      const data = lines.map(line => line.split(',').map(cell => cell.trim()));
      cache.estruturaCsv = data;
      return data;
    }

    function expandRow(row){
      let lastValue = "";
      return row.map(cell => {
        if(cell) lastValue = cell;
        return lastValue;
      });
    }

    function groupCells(grid){
      const visited = Array.from({ length:grid.length }, () => Array(grid[0].length).fill(false));
      const groups = [];
      const rows = grid.length;
      const cols = grid[0].length;
      const directions = [[0,1],[1,0],[-1,0],[0,-1]];
      function bfs(r,c,value){
        const queue = [[r,c]];
        const group = [];
        while(queue.length){
          const [x,y] = queue.shift();
          if(x<0||x>=rows||y<0||y>=cols||visited[x][y]||grid[x][y]!==value) continue;
          visited[x][y] = true;
          group.push([x,y]);
          for(const [dx,dy] of directions) queue.push([x+dx,y+dy]);
        }
        return group;
      }
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cellValue = grid[r][c];
          if(!visited[r][c] && cellValue && cellValue.toLowerCase()!=="vazio"){
            groups.push({ value:cellValue, cells:bfs(r,c,cellValue) });
          }
        }
      }
      return groups;
    }

    function formatDateBR(dateStr){
      if(!dateStr) return "";
      const parts = dateStr.split('-');
      if(parts.length<3) return dateStr;
      const yyyy = parseInt(parts[0],10);
      const mm = parseInt(parts[1],10)-1;
      const dd = parseInt(parts[2].substring(0,2),10);
      const d = new Date(yyyy,mm,dd);
      if(isNaN(d)) return dateStr;
      return `${String(dd).padStart(2,'0')}/${String(mm+1).padStart(2,'0')}/${yyyy}`;
    }

    function getUltimaInspecaoInfo(reaberturas){
      if(!Array.isArray(reaberturas)||reaberturas.length===0){
        return { codigo_ultima_inspecao:null, qtd_pend_ultima_inspecao:0 };
      }
      let best=null;
      for(const r of reaberturas){
        const c = Number(r.codigo);
        if(!Number.isNaN(c)){
          if(!best || c>best.c) best = { c, q:Number(r.qtd_itens_pendentes)||0 };
        }
      }
      if(best) return { codigo_ultima_inspecao:String(best.c), qtd_pend_ultima_inspecao:best.q };
      const last = reaberturas[reaberturas.length-1];
      return {
        codigo_ultima_inspecao: last.codigo ?? null,
        qtd_pend_ultima_inspecao: Number(last.qtd_itens_pendentes) || 0
      };
    }

    function draw(groups, duracoesMap, fvsSelecionada){
      const svg = document.getElementById('svg');
      svg.innerHTML = '';
      let maxWidth=0, maxHeight=0;

      groups.forEach(group=>{
        if(group.value.toLowerCase()==='vazio') return;
        const cells = group.cells;
        let minRow=Infinity, minCol=Infinity, maxRow=-1, maxCol=-1;
        for(const [r,c] of cells){
          minRow=Math.min(minRow,r); minCol=Math.min(minCol,c);
          maxRow=Math.max(maxRow,r); maxCol=Math.max(maxCol,c);
        }
        const x = minCol*CELL_WIDTH;
        const y = minRow*CELL_HEIGHT;
        const width = (maxCol-minCol+1)*CELL_WIDTH;
        const height = (maxRow-minRow+1)*CELL_HEIGHT;

        maxWidth = Math.max(maxWidth, x+width);
        maxHeight = Math.max(maxHeight, y+height);

        const data = duracoesMap[group.value];
        let fillColor = '#6e7681';
        let textoCentro = '';
        if(data){
          textoCentro = `${data.duracao_real ?? ''}`;
          if(!data.data_termino_inicial){
            fillColor = '#1f6feb';
          }else{
            const { qtd_pend_ultima_inspecao } = getUltimaInspecaoInfo(data.reaberturas);
            fillColor = qtd_pend_ultima_inspecao>0 ? '#d29922' : '#238636';
          }
        }

        const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
        rect.setAttribute("x",x); rect.setAttribute("y",y);
        rect.setAttribute("width",width); rect.setAttribute("height",height);
        rect.setAttribute("fill",fillColor); rect.setAttribute("class","cell");
        svg.appendChild(rect);

        const aptText = document.createElementNS("http://www.w3.org/2000/svg","text");
        aptText.setAttribute("x",x+3); aptText.setAttribute("y",y+3);
        aptText.setAttribute("class","apt-text"); aptText.textContent = group.value;
        svg.appendChild(aptText);

        const duracaoText = document.createElementNS("http://www.w3.org/2000/svg","text");
        duracaoText.setAttribute("x",x+width/2); duracaoText.setAttribute("y",y+height/2);
        duracaoText.setAttribute("class","duracao-text"); duracaoText.textContent = textoCentro;
        svg.appendChild(duracaoText);

        rect.addEventListener('click', ()=> abrirModalDetalhes(group.value, fvsSelecionada));
      });

      svg.setAttribute('viewBox', `0 0 ${maxWidth} ${maxHeight}`);
    }

    async function abrirModalDetalhes(apartamento, fvsSelecionada){
      modalContent.innerHTML = `<p>Carregando dados do apartamento ${apartamento}...</p>`;
      modalBackdrop.style.display = 'flex';
      lockScroll(true);
      try{
        const res = await fetch(`data/fvs/${encodeURIComponent(fvsSelecionada)}.json`);
        if (!res.ok) throw new Error(`JSON não encontrado para ${fvsSelecionada}`);
        const todosDados = await res.json();
        const info = todosDados[apartamento];

        if (!info) {
          modalContent.innerHTML = `<p>Sem dados para o apartamento ${apartamento}.</p>`;
          return;
        }

        const { codigo_ultima_inspecao, qtd_pend_ultima_inspecao } = getUltimaInspecaoInfo(info.reaberturas);

        let html = `<p><strong>Apartamento:</strong> ${apartamento}</p>`;
        html += `<p><strong>Início:</strong> ${formatDateBR(info.data_abertura)}</p>`;
        if(info.data_termino_inicial){
          html += `<p><strong>Término:</strong> ${formatDateBR(info.data_termino_inicial)}</p>`;
        }
        html += `<p><strong>Duração inicial:</strong> ${info.duracao_inicial}</p>`;

        if(info.reaberturas?.length){
          html += `<hr><table><tr><th>Código</th><th>Data Abertura</th><th>Pendências</th></tr>`;
          info.reaberturas.forEach(r=>{
            html += `<tr><td>${r.codigo ?? '-'}</td><td>${formatDateBR(r.data_abertura)}</td><td>${r.qtd_itens_pendentes}</td></tr>`;
          });
          html += `</table>`;
          html += `<p><strong>Duração reinspeções:</strong> ${info.duracao_reaberturas || 0}</p>`;
        }

        if (codigo_ultima_inspecao) {
          const linkUrl = `https://app.inmeta.com.br/app/360/servico/inspecoes/realizadas?inspecao=${info.id}`;
          html += `<p style="cursor:pointer;" onclick="window.open('${linkUrl}', '_blank')">
                    <strong>Última inspeção:</strong> código ${codigo_ultima_inspecao} | pendências ${qtd_pend_ultima_inspecao}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                      style="width:16px; height:16px; vertical-align:middle; margin-left:6px;">
                      <path d="M15 3h6v6"></path>
                      <path d="M10 14L21 3"></path>
                      <path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    </svg>
                  </p>`;
        }

        html += `<p><strong>Duração total:</strong> ${info.duracao_real}</p>`;
        modalContent.innerHTML = html;
        requestAnimationFrame(()=> document.getElementById('modal').focus());
      }catch(err){
        modalContent.innerHTML = `<p>Erro ao carregar dados: ${err.message}</p>`;
      }
    }

    function fecharModal(){
      modalBackdrop.style.display = 'none';
      modalContent.innerHTML = '';
      lockScroll(false);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      carregarFvs();
      document.getElementById('dropdown').addEventListener('change', e=>{
        carregarDuracoesEFazerDraw(e.target.value);
      });
      modalCloseBtn.addEventListener('click', fecharModal);
      modalBackdrop.addEventListener('click', e=>{
        if(e.target === modalBackdrop) fecharModal();
      });
      document.addEventListener('keydown', e=>{
        if(e.key==='Escape' && getComputedStyle(modalBackdrop).display==='flex') fecharModal();
      });
    });

    async function carregarFvs(){
      const dropdown = document.getElementById('dropdown');
      dropdown.innerHTML = '<option value="">Carregando FVS...</option>';
      try{
        if(cache.fvsList){ preencherDropdown(cache.fvsList); return; }
        const res = await fetch(`${API_BASE}?tipo=fvs`);
        const fvsList = await res.json();
        cache.fvsList = fvsList;
        preencherDropdown(fvsList);
      }catch(e){
        dropdown.innerHTML = '<option value="">Erro ao carregar FVS</option>';
      }
    }
    function preencherDropdown(fvsList){
      const dropdown = document.getElementById('dropdown');
      dropdown.innerHTML = '<option value="">-- Selecione uma FVS --</option>';
      for(const fvs of fvsList){
        const opt = document.createElement('option');
        opt.value = fvs; opt.textContent = fvs;
        dropdown.appendChild(opt);
      }
    }

    async function carregarDuracoesEFazerDraw(fvsSelecionada){
      showLoading();
      try{
        const rawGrid = await loadCSV(ESTRUTURA_CSV);
        const grid = rawGrid.map(row => expandRow(row.slice(1)));
        const groups = groupCells(grid);

        let duracoesMap = {};
        if(fvsSelecionada){
          const res = await fetch(`data/fvs/${encodeURIComponent(fvsSelecionada)}.json`);
          if (!res.ok) throw new Error(`JSON não encontrado para ${fvsSelecionada}`);
          const dados = await res.json();
          Object.keys(dados).forEach(apartamento => {
            duracoesMap[apartamento] = dados[apartamento];
          });
        }
        draw(groups, duracoesMap, fvsSelecionada);
      }catch(e){
        document.getElementById('svg').innerHTML =
          `<text x="10" y="20" fill="#c9d1d9">Erro: ${e.message}</text>`;
      }finally{
        hideLoading();
      }
    }
  </script>
</body>
</html>
